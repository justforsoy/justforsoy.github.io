<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-01-14">

<title>Rock’s blog - 【Bayesian Modeling and Computation in Python】3.线性模型和概率编程语言</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Rock’s blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/justforsoy" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">【Bayesian Modeling and Computation in Python】3.线性模型和概率编程语言</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">读书摘录</div>
                <div class="quarto-category">贝叶斯建模</div>
                <div class="quarto-category">Bayesian Modeling and Computation in Python</div>
                <div class="quarto-category">贝叶斯</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 14, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>随着概率编程语言的出现，现代贝叶斯建模可以像创建模型然后“按下按钮”一样简单。然而，想要做好需要更多的工作。本章介绍线性模型。线性模型是一类广泛的模型，其中给定观测值的期望值是相关预测变量的线性组合。深刻理解如何拟合和解释线性模型是后续模型的基础。</p>
<section id="比较两个或多个分组" class="level2">
<h2 class="anchored" data-anchor-id="比较两个或多个分组">3.1. 比较两个或多个分组</h2>
<p>假设在做企鹅相关研究：“每种企鹅的平均质量是多少？”，“这些平均值有多大差异？”，“平均值的离差是多少？”…… Luckily Kristen Gorman 收集了阿德利 (Adelie)、巴布亚 (Gentoo) 和帽带 (Chinstrap) 三种企鹅的数据，记录在 Palmer Penguins 数据集中。</p>
<p>加载数据集并过滤确实数据的行：</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> special, stats</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pytensor <span class="im">import</span> tensor <span class="im">as</span> tt</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Last Run </span><span class="sc">{</span>datetime<span class="sc">.</span>datetime<span class="sc">.</span>now()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Last Run 2024-01-14 18:18:08.421559</code></pre>
</div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>az.style.use(<span class="st">"arviz-grayscale"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'figure.dpi'</span>] <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_label_resizer(axes, fontsize<span class="op">=</span><span class="dv">14</span>):</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Resizes the axes labels of plots"""</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax <span class="kw">in</span> axes.ravel():</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> ([ax.title, ax.xaxis.label, ax.yaxis.label] <span class="op">+</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                     ax.get_xticklabels() <span class="op">+</span> ax.get_yticklabels()):</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>            item.set_fontsize(fontsize)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>penguins <span class="op">=</span> pd.read_csv(<span class="st">"../data/penguins.csv"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset to the columns needed</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>missing_data <span class="op">=</span> penguins.isnull()[</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"bill_length_mm"</span>, <span class="st">"flipper_length_mm"</span>, <span class="st">"sex"</span>, <span class="st">"body_mass_g"</span>]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>].<span class="bu">any</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows with any missing data</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>penguins <span class="op">=</span> penguins.loc[<span class="op">~</span>missing_data]</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>penguins.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">species</th>
<th data-quarto-table-cell-role="th">island</th>
<th data-quarto-table-cell-role="th">bill_length_mm</th>
<th data-quarto-table-cell-role="th">bill_depth_mm</th>
<th data-quarto-table-cell-role="th">flipper_length_mm</th>
<th data-quarto-table-cell-role="th">body_mass_g</th>
<th data-quarto-table-cell-role="th">sex</th>
<th data-quarto-table-cell-role="th">year</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>39.1</td>
<td>18.7</td>
<td>181.0</td>
<td>3750.0</td>
<td>male</td>
<td>2007</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>39.5</td>
<td>17.4</td>
<td>186.0</td>
<td>3800.0</td>
<td>female</td>
<td>2007</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>40.3</td>
<td>18.0</td>
<td>195.0</td>
<td>3250.0</td>
<td>female</td>
<td>2007</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>36.7</td>
<td>19.3</td>
<td>193.0</td>
<td>3450.0</td>
<td>female</td>
<td>2007</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>39.3</td>
<td>20.6</td>
<td>190.0</td>
<td>3650.0</td>
<td>male</td>
<td>2007</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>统计质量的统计量：</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>summary_stats <span class="op">=</span> (penguins.loc[:, [<span class="st">"species"</span>, <span class="st">"body_mass_g"</span>]]</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                         .groupby(<span class="st">"species"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                         .agg([<span class="st">"mean"</span>, <span class="st">"std"</span>, <span class="st">"count"</span>]))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>summary_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th colspan="3" data-quarto-table-cell-role="th" data-halign="left">body_mass_g</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
<tr class="header">
<th data-quarto-table-cell-role="th">species</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Adelie</td>
<td>3706.164384</td>
<td>458.620135</td>
<td>146</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Chinstrap</td>
<td>3733.088235</td>
<td>384.335081</td>
<td>68</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Gentoo</td>
<td>5092.436975</td>
<td>501.476154</td>
<td>119</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>上面得到了统计量的点估计，但是其不确定性是未知的。我们可以通过贝叶斯方法来评估。为此我们需要推测观测值与参数的关系，例如： <span class="math display">\[\overbrace{p(\mu, \sigma \mid Y)}^{Posterior} \propto \overbrace{\mathcal{N}(Y \mid \mu, \sigma)}^{Likelihood}\;  \overbrace{\underbrace{\mathcal{N}(4000, 3000)}_{\mu}
     \underbrace{\mathcal{H}\text{T}(100, 2000)}_{\sigma}}^{Prior}\]</span></p>
<p>以上对 <span class="math inline">\(\mu\)</span> 和 <span class="math inline">\(\sigma\)</span> 的选择了比较宽的先验分布。在这种情况下，先验是根据观测数据的经验平均值和标准差来选择的。一般来说，高斯分布对于企鹅质量来说是一个合理的可能性选择。<br>
我们先来分析 Adelie 种群：</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>adelie_mask <span class="op">=</span> (penguins[<span class="st">"species"</span>] <span class="op">==</span> <span class="st">"Adelie"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>adelie_mass_obs <span class="op">=</span> penguins.loc[adelie_mask, <span class="st">"body_mass_g"</span>].values</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model_adelie_penguin_mass:</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    σ <span class="op">=</span> pm.HalfStudentT(<span class="st">"σ"</span>, <span class="dv">100</span>, <span class="dv">2000</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    μ <span class="op">=</span> pm.Normal(<span class="st">"μ"</span>, <span class="dv">4000</span>, <span class="dv">3000</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    mass <span class="op">=</span> pm.Normal(<span class="st">"mass"</span>, mu<span class="op">=</span>μ, sigma<span class="op">=</span>σ, observed<span class="op">=</span>adelie_mass_obs)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    prior <span class="op">=</span> pm.sample_prior_predictive(samples<span class="op">=</span><span class="dv">5000</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    inf_data_adelie_penguin_mass <span class="op">=</span> pm.sample(chains<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [mass, μ, σ]
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [σ, μ]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 22 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:03&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
<p>计算之前要先检查先验分布，确认代码可执行及先验假设是否合理。</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>az.plot_posterior(prior, group<span class="op">=</span><span class="st">"prior"</span>, textsize<span class="op">=</span><span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>array([&lt;Axes: title={'center': 'σ'}&gt;, &lt;Axes: title={'center': 'μ'}&gt;],
      dtype=object)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-7-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>从先验样本本身来看，也许过于宽泛了，因为均值包含较大范围的负数，可以优化。但是作为一个简单示例，且我们有相当数量的观测结果，我们将继续进行后验分布评估。</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>az.summary(inf_data_adelie_penguin_mass)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_3%</th>
<th data-quarto-table-cell-role="th">hdi_97%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ</td>
<td>3705.420</td>
<td>37.763</td>
<td>3634.882</td>
<td>3775.517</td>
<td>0.576</td>
<td>0.407</td>
<td>4311.0</td>
<td>2465.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">σ</td>
<td>463.265</td>
<td>27.511</td>
<td>410.183</td>
<td>513.074</td>
<td>0.424</td>
<td>0.301</td>
<td>4238.0</td>
<td>2893.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> az.plot_trace(inf_data_adelie_penguin_mass, divergences<span class="op">=</span><span class="st">"bottom"</span>, kind<span class="op">=</span><span class="st">"rank_bars"</span>)<span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>plot_label_resizer(axes, fontsize<span class="op">=</span><span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>在从模型抽样后，我们得到上面的4个子图，右边两个是Rank图（如果4个链来自相同后验分布，它们混合排序后，各自的排名应该是相似的），左边是 KDE 图。也可以通过表格来进行分析。<br>
从上来看，模型的拟合是可以接受的。</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> az.plot_posterior(inf_data_adelie_penguin_mass, textsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>通过上面的贝叶斯估计，我们得到了统计量的不确定性范围。</p>
<p>我们可以用相同的方法评估其他两个种群。</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pd.categorical makes it easy to index species below</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>all_species <span class="op">=</span> pd.Categorical(penguins[<span class="st">"species"</span>])</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model_penguin_mass_all_species:</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note the addition of the shape parameter</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    σ <span class="op">=</span> pm.HalfStudentT(<span class="st">"σ"</span>, <span class="dv">100</span>, <span class="dv">2000</span>, shape<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    μ <span class="op">=</span> pm.Normal(<span class="st">"μ"</span>, <span class="dv">4000</span>, <span class="dv">3000</span>, shape<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    mass <span class="op">=</span> pm.Normal(<span class="st">"mass"</span>,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                     mu<span class="op">=</span>μ[all_species.codes],</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>                     sigma<span class="op">=</span>σ[all_species.codes],</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>                     observed<span class="op">=</span>penguins[<span class="st">"body_mass_g"</span>])</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    trace <span class="op">=</span> pm.sample()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [σ, μ]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 23 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:05&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>trace <span class="op">=</span> trace.assign_coords(coords<span class="op">=</span>{<span class="st">"μ_dim_0"</span>: all_species.categories,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                <span class="st">"σ_dim_0"</span>: all_species.categories})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> az.plot_trace(trace, compact<span class="op">=</span><span class="va">False</span>, divergences<span class="op">=</span><span class="st">"bottom"</span>, kind<span class="op">=</span><span class="st">"rank_bars"</span>)<span class="op">;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>plot_label_resizer(axes, fontsize<span class="op">=</span><span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>可以通过 <code>az.plot_forest</code> 来更方便的比较不同种群的差异。</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> az.plot_forest(trace, var_names<span class="op">=</span>[<span class="st">"μ"</span>], figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">2.5</span>))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"μ Mass Estimate: 94.0% HDI"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>Text(0.5, 1.0, 'μ Mass Estimate: 94.0% HDI')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-14-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>从上图可知 Gentoo 有更大的均值。让我们来看看标准差。</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> az.plot_forest(trace, var_names<span class="op">=</span>[<span class="st">"σ"</span>], figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">2.5</span>))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"σ Mass Estimate: 94.0% HDI"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>Text(0.5, 1.0, 'σ Mass Estimate: 94.0% HDI')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-15-output-2.png" class="img-fluid"></p>
</div>
</div>
<section id="比较两种概率编程语言-ppls" class="level3">
<h3 class="anchored" data-anchor-id="比较两种概率编程语言-ppls">3.1.1. 比较两种概率编程语言 PPLs</h3>
<p>后续会使用 PyMC 与 TensorFlow Probability (TFP) 来进行编程。</p>
<p>学习不同的 PPL 似乎没有必要。然而在本书中选择使用两个 PPL 而不是一个 PPL 是有特定原因的。在不同的 PPL 中看到相同的工作流程将使您对计算贝叶斯建模有更全面的了解，帮助您将计算细节与统计思想分开，并使您成为整体上更强大的建模者。而且，不同的PPL有不同的强度和侧重点。 PyMC3 是一种更高级别的 PPL，可以更轻松地用更少的代码表达模型，而 TFP 则为可组合建模和推理提供较低级别的 PPL。另一个问题是，并非所有 PPL 都能够像彼此一样轻松地表达所有模型。例如，时间序列模型（第 6 章）在 TFP 中更容易定义，而贝叶斯加法回归树在 PyMC（第 7 章）中更容易表达。通过接触多种语言，您将对贝叶斯建模的基本要素以及它们的计算实现方式有更深入的了解。</p>
</section>
</section>
<section id="线性回归" class="level2">
<h2 class="anchored" data-anchor-id="线性回归">3.2. 线性回归</h2>
<p>上一节中我们评估了质量和种群的关系，但是还可以有很多其它数据与质量相关，比如脚蹼的长度等。一种最简单的方法是使用线性回归来评估它们间的关系。<br>
<span class="math display">\[\begin{split}
    \mu =&amp; \beta_0 + \beta_1 X_1 + \dots + \beta_m X_m \\
Y \sim&amp; \mathcal{N}(\mu, \sigma)
\end{split}\]</span></p>
<p>其中每个 <span class="math inline">\(\beta_i\)</span> 参数都是一个随机变量。也可以通过矩阵来表示： <span class="math display">\[\mu = \mathbf{X}\boldsymbol{\beta}\]</span></p>
<p>在非贝叶斯框架下，参数被认为是确定的，并单独讲噪音分开，因此表示为： <span class="math display">\[Y = \mathbf{X}\boldsymbol{\beta} + \epsilon,\; \epsilon \sim \mathcal{N}(0, \sigma)\]</span></p>
<section id="线性的企鹅" class="level3">
<h3 class="anchored" data-anchor-id="线性的企鹅">3.2.1. 线性的企鹅</h3>
<p>我们没有什么先验知识，所以我们选择一个宽泛的先验分布，<span class="math inline">\(\beta_i \sim \mathcal{N}(0, 4000)\)</span>。让我们在 adelie 上考虑脚蹼长度来建模：</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>adelie_flipper_length_obs <span class="op">=</span> penguins.loc[adelie_mask, <span class="st">"flipper_length_mm"</span>]</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model_adelie_flipper_regression:</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pm.Data allows us to change the underlying value in a later code block</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    adelie_flipper_length <span class="op">=</span> pm.Data(<span class="st">"adelie_flipper_length"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                                    adelie_flipper_length_obs, mutable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    σ <span class="op">=</span> pm.HalfStudentT(<span class="st">"σ"</span>, <span class="dv">100</span>, <span class="dv">2000</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    β_0 <span class="op">=</span> pm.Normal(<span class="st">"β_0"</span>, <span class="dv">0</span>, <span class="dv">4000</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    β_1 <span class="op">=</span> pm.Normal(<span class="st">"β_1"</span>, <span class="dv">0</span>, <span class="dv">4000</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    μ <span class="op">=</span> pm.Deterministic(<span class="st">"μ"</span>, β_0 <span class="op">+</span> β_1 <span class="op">*</span> adelie_flipper_length)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    mass <span class="op">=</span> pm.Normal(<span class="st">"mass"</span>, mu<span class="op">=</span>μ, sigma<span class="op">=</span>σ, observed <span class="op">=</span> adelie_mass_obs)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    inf_data_adelie_flipper_regression <span class="op">=</span> pm.sample(return_inferencedata<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [σ, β_0, β_1]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 37 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:19&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
<p>为了节省篇幅，这里不进行模型诊断，在真实应用场景下请一定注意诊断。</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> az.plot_posterior(inf_data_adelie_flipper_regression, var_names <span class="op">=</span> [<span class="st">"β_0"</span>, <span class="st">"β_1"</span>], textsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>从上可知，脚蹼长度与质量呈正相关，每增加1mm质量增加约32g，而且其 94% HDI 不包含0，这支持了脚蹼长度与质量有关的看法。请注意这不代表因果，例如人为手术增加脚蹼长度，质量不会增加。<br>
我们可以推测，增加脚蹼协变量将有助于更好地预测企鹅的质量。我们可以通过 <span class="math inline">\(\sigma\)</span> 来验证，对比固定均值模型和线性模型，<span class="math inline">\(\sigma\)</span> 变小了</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> az.plot_forest(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    [inf_data_adelie_penguin_mass, inf_data_adelie_flipper_regression],</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    model_names<span class="op">=</span>[<span class="st">"mass_only"</span>, <span class="st">"flipper_regression"</span>],</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    var_names<span class="op">=</span>[<span class="st">"σ"</span>], combined<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">4</span>))</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"σ Comparison 94.0 HDI"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>Text(0.5, 1.0, 'σ Comparison 94.0 HDI')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-18-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>alpha_m <span class="op">=</span> inf_data_adelie_flipper_regression.posterior.mean().to_dict()[<span class="st">"data_vars"</span>][<span class="st">"β_0"</span>][<span class="st">"data"</span>]</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>beta_m <span class="op">=</span> inf_data_adelie_flipper_regression.posterior.mean().to_dict()[<span class="st">"data_vars"</span>][<span class="st">"β_1"</span>][<span class="st">"data"</span>]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>flipper_length <span class="op">=</span> np.linspace(adelie_flipper_length_obs.<span class="bu">min</span>(), adelie_flipper_length_obs.<span class="bu">max</span>(), <span class="dv">100</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>flipper_length_mean <span class="op">=</span> alpha_m <span class="op">+</span> beta_m <span class="op">*</span> flipper_length</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>ax.plot(flipper_length, flipper_length_mean, c<span class="op">=</span><span class="st">'C4'</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="ss">f'y = </span><span class="sc">{</span>alpha_m<span class="sc">:.2f}</span><span class="ss"> + </span><span class="sc">{</span>beta_m<span class="sc">:.2f}</span><span class="ss"> * x'</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>ax.scatter(adelie_flipper_length_obs, adelie_mass_obs)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Figure out how to do this from inference data</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>az.plot_hdi(adelie_flipper_length_obs, inf_data_adelie_flipper_regression.posterior[<span class="st">'μ'</span>], hdi_prob<span class="op">=</span><span class="fl">0.94</span>, color<span class="op">=</span><span class="st">'k'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Flipper Length'</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Mass'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="预测" class="level3">
<h3 class="anchored" data-anchor-id="预测">3.2.2. 预测</h3>
<p>上面建立了脚蹼和质量的模型，因此根据脚蹼长度，我们可以预测企鹅的质量。比如我们知道一个企鹅的脚蹼长度为均值，可以预测其后验均值和观测值。</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> model_adelie_flipper_regression:</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Change the underlying value to the mean observed flipper length</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for our posterior predictive samples</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    pm.set_data({<span class="st">"adelie_flipper_length"</span>: [adelie_flipper_length_obs.mean()]})</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    posterior_predictions <span class="op">=</span> pm.sample_posterior_predictive(</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>        inf_data_adelie_flipper_regression.posterior, var_names<span class="op">=</span>[<span class="st">"mass"</span>, <span class="st">"μ"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [mass]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="4000" class="" max="4000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [4000/4000 00:00&lt;00:00]
    </div>
    
</div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>az.plot_dist(posterior_predictions.posterior_predictive[<span class="st">"mass"</span>], label<span class="op">=</span><span class="st">"Posterior Predictive of </span><span class="ch">\n</span><span class="st">Individual Penguin Mass"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>az.plot_dist(posterior_predictions.posterior_predictive[<span class="st">"μ"</span>],label<span class="op">=</span><span class="st">"Posterior Predictive of μ"</span>, color<span class="op">=</span><span class="st">"C4"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">2900</span>, <span class="dv">4500</span>)<span class="op">;</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Mass (grams)"</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>ax.set_yticks([])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>[]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-21-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>后验预测分布在贝叶斯背景下是一个特别强大的工具，因为它不仅让我们预测最可能的值，还让我们预测包含我们估计的不确定性的合理值的分布。</p>
</section>
<section id="centering" class="level3">
<h3 class="anchored" data-anchor-id="centering">3.2.3. Centering</h3>
<p>上面的模型效果不错，但可惜的是其 <span class="math inline">\(\beta_0\)</span> 不是很有实际意义。可以通过变换让它更可解释。</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>adelie_flipper_length_c <span class="op">=</span> (adelie_flipper_length_obs <span class="op">-</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>                           adelie_flipper_length_obs.mean())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model_adelie_flipper_regression_c:</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pm.Data allows us to change the underlying value in a later code block</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    adelie_flipper_length <span class="op">=</span> pm.Data(<span class="st">"adelie_flipper_length"</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                                    adelie_flipper_length_c, mutable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    σ <span class="op">=</span> pm.HalfStudentT(<span class="st">"σ"</span>, <span class="dv">100</span>, <span class="dv">2000</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    β_0 <span class="op">=</span> pm.Normal(<span class="st">"β_0"</span>, <span class="dv">0</span>, <span class="dv">4000</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    β_1 <span class="op">=</span> pm.Normal(<span class="st">"β_1"</span>, <span class="dv">0</span>, <span class="dv">4000</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    μ <span class="op">=</span> pm.Deterministic(<span class="st">"μ"</span>, β_0 <span class="op">+</span> β_1 <span class="op">*</span> adelie_flipper_length)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    mass <span class="op">=</span> pm.Normal(<span class="st">"mass"</span>, mu<span class="op">=</span>μ, sigma<span class="op">=</span>σ, observed <span class="op">=</span> adelie_mass_obs)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    inf_data_adelie_flipper_regression_c <span class="op">=</span> pm.sample(return_inferencedata<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [σ, β_0, β_1]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 24 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:05&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> az.plot_posterior(inf_data_adelie_flipper_regression_c, var_names <span class="op">=</span> [<span class="st">"β_0"</span>, <span class="st">"β_1"</span>], textsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-24-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>重新绘制参数，此时 <span class="math inline">\(\beta_1\)</span> 无变化， <span class="math inline">\(\beta_0\)</span> 有了意义，表示种群的平均质量。</p>
</section>
</section>
<section id="多变量线性回归" class="level2">
<h2 class="anchored" data-anchor-id="多变量线性回归">3.3. 多变量线性回归</h2>
<p>很多物种中不同性别的体型有很大差异，因此我们可以考虑性别作为一个协变量，然后看我们的评估能否更加精确。</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Binary encoding of the categorical predictor</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>sex_obs <span class="op">=</span> penguins.loc[adelie_mask ,<span class="st">"sex"</span>].replace({<span class="st">"male"</span>:<span class="dv">0</span>, <span class="st">"female"</span>:<span class="dv">1</span>})</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model_penguin_mass_categorical:</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    σ <span class="op">=</span> pm.HalfStudentT(<span class="st">"σ"</span>, <span class="dv">100</span>, <span class="dv">2000</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    β_0 <span class="op">=</span> pm.Normal(<span class="st">"β_0"</span>, <span class="dv">0</span>, <span class="dv">3000</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    β_1 <span class="op">=</span> pm.Normal(<span class="st">"β_1"</span>, <span class="dv">0</span>, <span class="dv">3000</span>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    β_2 <span class="op">=</span> pm.Normal(<span class="st">"β_2"</span>, <span class="dv">0</span>, <span class="dv">3000</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    μ <span class="op">=</span> pm.Deterministic(</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"μ"</span>, β_0 <span class="op">+</span> β_1 <span class="op">*</span> adelie_flipper_length_obs <span class="op">+</span> β_2 <span class="op">*</span> sex_obs)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    mass <span class="op">=</span> pm.Normal(<span class="st">"mass"</span>, mu<span class="op">=</span>μ, sigma<span class="op">=</span>σ, observed<span class="op">=</span>adelie_mass_obs)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    inf_data_penguin_mass_categorical <span class="op">=</span> pm.sample(</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>        target_accept<span class="op">=</span><span class="fl">.9</span>, return_inferencedata<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [σ, β_0, β_1, β_2]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 49 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:30&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>az.plot_posterior(inf_data_penguin_mass_categorical, var_names <span class="op">=</span>[<span class="st">"β_0"</span>, <span class="st">"β_1"</span>, <span class="st">"β_2"</span>], textsize<span class="op">=</span><span class="dv">30</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-26-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>由于我们将雄性编码为 0，因此后验估计了与具有相同鳍状肢长度的雌性阿德利企鹅相比的质量差异。在解释系数时必须更加小心，如果所有其他协变量保持不变，则系数提供了协变量与响应变量的关系。</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>alpha_1 <span class="op">=</span> inf_data_penguin_mass_categorical.posterior.mean().to_dict()[<span class="st">"data_vars"</span>][<span class="st">"β_0"</span>][<span class="st">"data"</span>]</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>beta_1 <span class="op">=</span> inf_data_penguin_mass_categorical.posterior.mean().to_dict()[<span class="st">"data_vars"</span>][<span class="st">"β_1"</span>][<span class="st">"data"</span>]</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>beta_2 <span class="op">=</span> inf_data_penguin_mass_categorical.posterior.mean().to_dict()[<span class="st">"data_vars"</span>][<span class="st">"β_2"</span>][<span class="st">"data"</span>]</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>flipper_length <span class="op">=</span> np.linspace(adelie_flipper_length_obs.<span class="bu">min</span>(), adelie_flipper_length_obs.<span class="bu">max</span>(), <span class="dv">100</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>mass_mean_male <span class="op">=</span> alpha_1 <span class="op">+</span> beta_1 <span class="op">*</span> flipper_length</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>mass_mean_female <span class="op">=</span> alpha_1 <span class="op">+</span> beta_1 <span class="op">*</span> flipper_length <span class="op">+</span> beta_2</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>ax.plot(flipper_length, mass_mean_male,</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">"Male"</span>)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>ax.plot(flipper_length, mass_mean_female, c<span class="op">=</span><span class="st">'C4'</span>,</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">"Female"</span>)</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>ax.scatter(adelie_flipper_length_obs, adelie_mass_obs, c<span class="op">=</span>[{<span class="dv">0</span>:<span class="st">"k"</span>, <span class="dv">1</span>:<span class="st">"b"</span>}[code] <span class="cf">for</span> code <span class="kw">in</span> sex_obs.values])</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Figure out how to do this from inference data</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="co">#az.plot_hpd(adelie_flipper_length, trace.get_values(varname="μ"), credible_interval=0.94, color='k', ax=ax)</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Flipper Length'</span>)</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Mass'</span>)<span class="op">;</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>ax.legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>&lt;matplotlib.legend.Legend at 0x17d977e10&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-27-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>验证可发现标准差是否变小了。这种不确定性的减少表明，性别确实为估计企鹅的质量提供了有用信息。</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>az.plot_forest([inf_data_adelie_penguin_mass,</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>        inf_data_adelie_flipper_regression,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>        inf_data_penguin_mass_categorical],</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>        model_names<span class="op">=</span>[<span class="st">"mass_only"</span>, <span class="st">"flipper_regression"</span>, <span class="st">"flipper_sex_regression"</span>],</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        var_names<span class="op">=</span>[<span class="st">"σ"</span>], combined<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">4</span>))</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"σ Comparison 94.0 HDI"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><mark>注意：协变量不是越多越好</mark></p>
<blockquote class="blockquote">
<p>所有模型拟合算法都会找到信号，即使它是随机噪声。这种现象称为过度拟合，它描述了一种情况，即算法可以轻松地将协变量映射到所见案例中的结果，但无法推广到新的观察结果。在线性回归中，我们可以通过生成 100 个随机协变量用它们拟合随机模拟数据集。即使没有关系，我们的线性模型表现得也会很好。</p>
</blockquote>
<section id="反事实" class="level3">
<h3 class="anchored" data-anchor-id="反事实">3.3.1. 反事实</h3>
<p>可以保持其他协变量不变，然后分析单个变量的影响，这称为反事实分析。下面增加喙长度建立多元线性回归模型，并进行反事实分析。</p>
</section>
</section>
<section id="广义线性模型" class="level2">
<h2 class="anchored" data-anchor-id="广义线性模型">3.4. 广义线性模型</h2>
以上所有线性模型都假设观测值的分布是条件高斯分布，但是有时候需要其它分布。比如，对 [0,1] 范围内的概率建模，对 {1, 2, 3,…} 数字建模。<br>
我们可以继续采用线性函数 <span class="math inline">\(\mathbf{X} \mathit{\beta}\)</span>，并且用逆链接函数 <span class="math inline">\(\phi\)</span> 对它进行处理： $$
<span class="math display">\[\begin{split}
\mu =&amp; \phi(\mathbf{X} \beta) \\
Y \sim&amp; \Psi (\mu, \theta)

\end{split}\]</span>
<p>$$</p>
<p>逆链接函数的具体目的是映射实数范围的输出到限制区间范围。换句话说，逆链接函数是我们需要采用线性模型并将其推广到更多模型架构的特定“技巧”。</p>
<section id="逻辑回归" class="level3">
<h3 class="anchored" data-anchor-id="逻辑回归">3.4.1. 逻辑回归</h3>
<p>逻辑回归是一种使用最广泛的广义线性模型之一，用于建模二元分类问题。它通过逆链接函数 logistic 将实数范围的输入映射到 [0,1] 范围的输出。 <span class="math display">\[p = \frac{1}{1+e^{-\mathbf{X}\beta}}\]</span></p>
<p><img src="logistic.png" class="img-fluid"></p>
<p>通过逻辑回归，我们能够使用线性模型来估计事件的概率。我们可以使用决策边界来在集合中进行预测 0 或 1 。如果决策边界设置为 0.5 ，对于具有截距和一个协变量的模型，我们有： <span class="math display">\[
\begin{split}
0.5 &amp;= logistic(\beta_{0} + \beta_{1}*x) \\
logit(0.5) &amp;= \beta_{0} + \beta_{1}*x \\
0 &amp;= \beta_{0} + \beta_{1}*x \\
x &amp;= -\frac{\beta_{0}}{\beta_{1}} \\
\end{split}
\]</span></p>
<p>其中 logit 是 logistic 的逆函数，也就是说模型训练后，我们也可以通过 <span class="math inline">\(\beta_0\)</span> 和 <span class="math inline">\(\beta_1\)</span> 来计算 <span class="math inline">\(x\)</span> 的决策边界。</p>
</section>
<section id="企鹅分类" class="level3">
<h3 class="anchored" data-anchor-id="企鹅分类">3.4.2. 企鹅分类</h3>
<p>如果给出企鹅的质量、性别、喙长度和脚蹼长度，我们能否预测其种类么？下面用 Adelie 和 Chinstrap 企鹅做二分类任务</p>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>species_filter <span class="op">=</span> penguins[<span class="st">"species"</span>].isin([<span class="st">"Adelie"</span>, <span class="st">"Chinstrap"</span>])</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>bill_length_obs <span class="op">=</span> penguins.loc[species_filter, <span class="st">"bill_length_mm"</span>].values</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>species <span class="op">=</span> pd.Categorical(penguins.loc[species_filter, <span class="st">"species"</span>])</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model_logistic_penguins_bill_length:</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    β_0 <span class="op">=</span> pm.Normal(<span class="st">"β_0"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    β_1 <span class="op">=</span> pm.Normal(<span class="st">"β_1"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    μ <span class="op">=</span> β_0 <span class="op">+</span> pm.math.dot(bill_length_obs, β_1)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Application of our sigmoid  link function</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    θ <span class="op">=</span> pm.Deterministic(<span class="st">"θ"</span>, pm.math.sigmoid(μ))</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Useful for plotting the decision boundary later</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    bd <span class="op">=</span> pm.Deterministic(<span class="st">"bd"</span>, <span class="op">-</span>β_0<span class="op">/</span>β_1)</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note the change in likelihood</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    yl <span class="op">=</span> pm.Bernoulli(<span class="st">"yl"</span>, p<span class="op">=</span>θ, observed<span class="op">=</span>species.codes)</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    loglik <span class="op">=</span> pm.Deterministic(<span class="st">'log_likelihood'</span>, pm.logp(yl, species.codes))</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    prior_predictive_logistic_penguins_bill_length <span class="op">=</span> pm.sample_prior_predictive(samples<span class="op">=</span><span class="dv">10000</span>)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    trace_logistic_penguins_bill_length <span class="op">=</span> pm.sample(<span class="dv">5000</span>, random_seed<span class="op">=</span><span class="dv">0</span>, chains<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    posterior_predictive_logistic_penguins_bill_length <span class="op">=</span> pm.sample_posterior_predictive(trace_logistic_penguins_bill_length)</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    trace_logistic_penguins_bill_length.extend(posterior_predictive_logistic_penguins_bill_length)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [yl, β_0, β_1]
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (2 chains in 4 jobs)
NUTS: [β_0, β_1]
Sampling 2 chains for 1_000 tune and 5_000 draw iterations (2_000 + 10_000 draws total) took 27 seconds.
We recommend running at least 4 chains for robust computation of convergence diagnostics
Sampling: [yl]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="12000" class="" max="12000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [12000/12000 00:15&lt;00:00 Sampling 2 chains, 0 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="10000" class="" max="10000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [10000/10000 00:00&lt;00:00]
    </div>
    
</div>
</div>
<p>在泛化线性模型中，先验模型参数与结果的关系更难理解了。我们可以利用先验的预测样本来可视化预期的观察结果。</p>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> az.plot_dist(prior_predictive_logistic_penguins_bill_length.prior_predictive.data_vars[<span class="st">'yl'</span>], color<span class="op">=</span><span class="st">"C2"</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels([<span class="st">"Adelie: 0"</span>, <span class="st">"Chinstrap: 1"</span>] )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>[Text(0.0, 0, 'Adelie: 0'), Text(1.0, 0, 'Chinstrap: 1')]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-30-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>从上图看，先验中认为两种企鹅可能性差不多，这是符合预期的。</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>az.plot_trace(trace_logistic_penguins_bill_length, var_names<span class="op">=</span>[<span class="st">"β_0"</span>, <span class="st">"β_1"</span>], kind<span class="op">=</span><span class="st">"rank_bars"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-31-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>在训练模型后，可以通过 <code>az.summary</code> 来查看参数的后验分布。可以发现 <span class="math inline">\(\beta_1\)</span> 的 HDI 不包含0，并且44mm的喙长度大概是分类边界。</p>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>az.summary(trace_logistic_penguins_bill_length, var_names<span class="op">=</span>[<span class="st">"β_0"</span>, <span class="st">"β_1"</span>], kind<span class="op">=</span><span class="st">"stats"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_3%</th>
<th data-quarto-table-cell-role="th">hdi_97%</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">β_0</td>
<td>-34.557</td>
<td>4.315</td>
<td>-43.199</td>
<td>-27.244</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">β_1</td>
<td>0.781</td>
<td>0.099</td>
<td>0.606</td>
<td>0.974</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>用下图展示更加直接。</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>theta <span class="op">=</span> trace_logistic_penguins_bill_length.posterior[<span class="st">"θ"</span>].values.reshape((<span class="op">-</span><span class="dv">1</span>,<span class="dv">214</span>)).mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> np.argsort(bill_length_obs)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Decision Boundary</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>ax.vlines(trace_logistic_penguins_bill_length.posterior[<span class="st">"bd"</span>].values.mean(), <span class="dv">0</span>, <span class="dv">1</span>, color<span class="op">=</span><span class="st">'k'</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>bd_hpd <span class="op">=</span> az.hdi(trace_logistic_penguins_bill_length.posterior[<span class="st">"bd"</span>].values.flatten(), ax<span class="op">=</span>ax)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>plt.fill_betweenx([<span class="dv">0</span>, <span class="dv">1</span>], bd_hpd[<span class="dv">0</span>], bd_hpd[<span class="dv">1</span>], color<span class="op">=</span><span class="st">'C2'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (label, marker) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(species.categories, (<span class="st">"."</span>, <span class="st">"s"</span>))):</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    _filter <span class="op">=</span> (species.codes <span class="op">==</span> i)</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> bill_length_obs[_filter]</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> np.random.normal(i, <span class="fl">0.02</span>, size<span class="op">=</span>_filter.<span class="bu">sum</span>())</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    ax.scatter(bill_length_obs[_filter], y, marker<span class="op">=</span>marker, label<span class="op">=</span>label, alpha<span class="op">=</span><span class="fl">.8</span>)</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>az.plot_hdi(bill_length_obs, trace_logistic_penguins_bill_length.posterior[<span class="st">"θ"</span>].values, color<span class="op">=</span><span class="st">'C4'</span>, ax<span class="op">=</span>ax, plot_kwargs<span class="op">=</span>{<span class="st">"zorder"</span>:<span class="dv">10</span>})</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>ax.plot(bill_length_obs[idx], theta[idx], color<span class="op">=</span><span class="st">'C4'</span>, zorder<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Bill Length (mm)"</span>)</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'θ'</span>, rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>plt.legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>&lt;matplotlib.legend.Legend at 0x17e42a790&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-33-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>如果用重量来预测呢？</p>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>mass_obs <span class="op">=</span> penguins.loc[species_filter, <span class="st">"body_mass_g"</span>].values</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model_logistic_penguins_mass:</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    β_0 <span class="op">=</span> pm.Normal(<span class="st">"β_0"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    β_1 <span class="op">=</span> pm.Normal(<span class="st">"β_1"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    μ <span class="op">=</span> β_0 <span class="op">+</span> pm.math.dot(mass_obs, β_1)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    θ <span class="op">=</span> pm.Deterministic(<span class="st">"θ"</span>, pm.math.sigmoid(μ))</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    bd <span class="op">=</span> pm.Deterministic(<span class="st">"bd"</span>, <span class="op">-</span>β_0<span class="op">/</span>β_1)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    yl <span class="op">=</span> pm.Bernoulli(<span class="st">"yl"</span>, p<span class="op">=</span>θ, observed<span class="op">=</span>species.codes)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    inf_data_logistic_penguins_mass <span class="op">=</span> pm.sample(</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>        <span class="dv">5000</span>, target_accept<span class="op">=</span><span class="fl">.9</span>, return_inferencedata<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    loglik <span class="op">=</span> pm.Deterministic(<span class="st">'log_likelihood'</span>, pm.logp(yl, species.codes))</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    trace_logistic_penguins_mass <span class="op">=</span> pm.sample(</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>        <span class="dv">5000</span>, random_seed<span class="op">=</span><span class="dv">0</span>, chains<span class="op">=</span><span class="dv">2</span>, target_accept<span class="op">=</span><span class="fl">.9</span>)</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    posterior_predictive_logistic_penguins_mass <span class="op">=</span> pm.sample_posterior_predictive(</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>        trace_logistic_penguins_mass)</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>    trace_logistic_penguins_mass.extend(posterior_predictive_logistic_penguins_mass)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [β_0, β_1]
Sampling 4 chains for 1_000 tune and 5_000 draw iterations (4_000 + 20_000 draws total) took 33 seconds.
The rhat statistic is larger than 1.01 for some parameters. This indicates problems during sampling. See https://arxiv.org/abs/1903.08008 for details
The effective sample size per chain is smaller than 100 for some parameters.  A higher number is needed for reliable rhat and ess computation. See https://arxiv.org/abs/1903.08008 for details
There were 5000 divergences after tuning. Increase `target_accept` or reparameterize.
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (2 chains in 4 jobs)
NUTS: [β_0, β_1]
Sampling 2 chains for 1_000 tune and 5_000 draw iterations (2_000 + 10_000 draws total) took 24 seconds.
We recommend running at least 4 chains for robust computation of convergence diagnostics
Sampling: [yl]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="24000" class="" max="24000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [24000/24000 00:14&lt;00:00 Sampling 4 chains, 5,000 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="12000" class="" max="12000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [12000/12000 00:13&lt;00:00 Sampling 2 chains, 0 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="10000" class="" max="10000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [10000/10000 00:01&lt;00:00]
    </div>
    
</div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>az.summary(inf_data_logistic_penguins_mass, var_names<span class="op">=</span>[<span class="st">"β_0"</span>, <span class="st">"β_1"</span>], kind<span class="op">=</span><span class="st">"stats"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_3%</th>
<th data-quarto-table-cell-role="th">hdi_97%</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">β_0</td>
<td>-1.145</td>
<td>1.111</td>
<td>-3.532</td>
<td>0.911</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">β_1</td>
<td>0.081</td>
<td>0.140</td>
<td>-0.000</td>
<td>0.324</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>theta <span class="op">=</span> inf_data_logistic_penguins_mass.posterior[<span class="st">'θ'</span>].values</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>bd <span class="op">=</span> inf_data_logistic_penguins_mass.posterior[<span class="st">'bd'</span>].values</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>theta <span class="op">=</span> theta.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">214</span>).mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> np.argsort(mass_obs)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>ax.plot(mass_obs[idx], theta[idx], color<span class="op">=</span><span class="st">'C4'</span>, lw<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (label, marker) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(species.categories, (<span class="st">"."</span>, <span class="st">"s"</span>))):</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    _filter <span class="op">=</span> (species.codes <span class="op">==</span> i)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> mass_obs[_filter]</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> np.random.normal(i, <span class="fl">0.02</span>, size<span class="op">=</span>_filter.<span class="bu">sum</span>())</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    ax.scatter(mass_obs[_filter], y, marker<span class="op">=</span>marker, label<span class="op">=</span>label, alpha<span class="op">=</span><span class="fl">.8</span>)</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>az.plot_hdi(mass_obs, inf_data_logistic_penguins_mass.posterior[<span class="st">'θ'</span>], color<span class="op">=</span><span class="st">'C4'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Mass (Grams)"</span>)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'θ'</span>, rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>plt.legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>&lt;matplotlib.legend.Legend at 0x17cd8da50&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-36-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>通过以上统计结果及图可知，重量无法对分类提供有效的信息。试试结合喙长度和重量一起。</p>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> penguins.loc[species_filter, [<span class="st">"bill_length_mm"</span>, <span class="st">"body_mass_g"</span>]]</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a column of 1s for the intercept</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>X.insert(<span class="dv">0</span>,<span class="st">"Intercept"</span>, value<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> X.values</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model_logistic_penguins_bill_length_mass:</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    β <span class="op">=</span> pm.Normal(<span class="st">"β"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="dv">20</span>, shape<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    μ <span class="op">=</span> pm.math.dot(X, β)</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    θ <span class="op">=</span> pm.Deterministic(<span class="st">"θ"</span>, pm.math.sigmoid(μ))</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    bd <span class="op">=</span> pm.Deterministic(<span class="st">"bd"</span>, <span class="op">-</span>β[<span class="dv">0</span>]<span class="op">/</span>β[<span class="dv">2</span>] <span class="op">-</span> β[<span class="dv">1</span>]<span class="op">/</span>β[<span class="dv">2</span>] <span class="op">*</span> X[:,<span class="dv">1</span>])</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    yl <span class="op">=</span> pm.Bernoulli(<span class="st">"yl"</span>, p<span class="op">=</span>θ, observed<span class="op">=</span>species.codes)</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    loglik <span class="op">=</span> pm.Deterministic(<span class="st">'log_likelihood'</span>, pm.logp(yl, species.codes))</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    trace_logistic_penguins_bill_length_mass <span class="op">=</span> pm.sample(</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>        <span class="dv">5000</span>, random_seed<span class="op">=</span><span class="dv">0</span>, chains<span class="op">=</span><span class="dv">2</span>, target_accept<span class="op">=</span><span class="fl">.9</span>)</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    posterior_predictive_logistic_penguins_bill_length_mass <span class="op">=</span> pm.sample_posterior_predictive(</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>        trace_logistic_penguins_bill_length_mass)</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    trace_logistic_penguins_bill_length_mass.extend(posterior_predictive_logistic_penguins_bill_length_mass)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (2 chains in 4 jobs)
NUTS: [β]
Sampling 2 chains for 1_000 tune and 5_000 draw iterations (2_000 + 10_000 draws total) took 49 seconds.
We recommend running at least 4 chains for robust computation of convergence diagnostics
Sampling: [yl]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="12000" class="" max="12000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [12000/12000 00:40&lt;00:00 Sampling 2 chains, 63 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="10000" class="" max="10000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [10000/10000 00:00&lt;00:00]
    </div>
    
</div>
</div>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>az.summary(trace_logistic_penguins_bill_length_mass, var_names<span class="op">=</span>[<span class="st">"β"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_3%</th>
<th data-quarto-table-cell-role="th">hdi_97%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">β[0]</td>
<td>-46.301</td>
<td>9.632</td>
<td>-64.668</td>
<td>-28.973</td>
<td>0.218</td>
<td>0.159</td>
<td>2039.0</td>
<td>2089.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">β[1]</td>
<td>1.887</td>
<td>0.406</td>
<td>1.123</td>
<td>2.623</td>
<td>0.010</td>
<td>0.007</td>
<td>1598.0</td>
<td>1717.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">β[2]</td>
<td>-0.010</td>
<td>0.003</td>
<td>-0.015</td>
<td>-0.005</td>
<td>0.000</td>
<td>0.000</td>
<td>1786.0</td>
<td>2106.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>fig,ax  <span class="op">=</span> plt.subplots()</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> np.argsort(X[:,<span class="dv">1</span>])</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>bd <span class="op">=</span> trace_logistic_penguins_bill_length_mass.posterior[<span class="st">"bd"</span>].values.reshape((<span class="op">-</span><span class="dv">1</span>,<span class="dv">214</span>)).mean(axis<span class="op">=</span><span class="dv">0</span>)[idx]</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>species_filter <span class="op">=</span> species.codes.astype(<span class="bu">bool</span>)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear fit</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>ax.plot(X[:,<span class="dv">1</span>][idx], bd, color<span class="op">=</span><span class="st">'C4'</span>)<span class="op">;</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>az.plot_hdi(X[:,<span class="dv">1</span>], trace_logistic_penguins_bill_length_mass.posterior[<span class="st">"bd"</span>].values.reshape((<span class="op">-</span><span class="dv">1</span>,<span class="dv">214</span>)), color<span class="op">=</span><span class="st">'C4'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>ax.scatter(X[<span class="op">~</span>species_filter,<span class="dv">1</span>], X[<span class="op">~</span>species_filter,<span class="dv">2</span>], alpha<span class="op">=</span><span class="fl">.8</span>,  label<span class="op">=</span><span class="st">"Adelie"</span>, zorder<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>ax.scatter(X[species_filter,<span class="dv">1</span>], X[species_filter,<span class="dv">2</span>], marker<span class="op">=</span><span class="st">"s"</span>, label<span class="op">=</span><span class="st">"Chinstrap"</span>, zorder<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Mass (grams)"</span>)</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Bill Length (mm)"</span>)</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>ax.legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/admin/blog/rock_blog/env/lib/python3.11/site-packages/arviz/plots/hdiplot.py:160: FutureWarning: hdi currently interprets 2d data as (draw, shape) but this will change in a future release to (chain, draw) for coherence with other functions
  hdi_data = hdi(y, hdi_prob=hdi_prob, circular=circular, multimodal=False, **hdi_kwargs)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>&lt;matplotlib.legend.Legend at 0x17d854d90&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-39-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>可以通过 separation plot 来更直观的看到分类效果。如果模型分类特别好，图形会是两个分离的长方体。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>trace_logistic_penguins_bill_length.add_groups({<span class="st">"log_likelihood"</span>: {<span class="st">"y"</span>:trace_logistic_penguins_bill_length.posterior.log_likelihood}})</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>trace_logistic_penguins_mass.add_groups({<span class="st">"log_likelihood"</span>: {<span class="st">"y"</span>:trace_logistic_penguins_mass.posterior.log_likelihood}})</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>trace_logistic_penguins_bill_length_mass.add_groups({<span class="st">"log_likelihood"</span>: {<span class="st">"y"</span>:trace_logistic_penguins_bill_length_mass.posterior.log_likelihood}})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> {<span class="st">"bill"</span>: trace_logistic_penguins_bill_length,</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>          <span class="st">"mass"</span>: trace_logistic_penguins_mass,</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>          <span class="st">"mass bill"</span>: trace_logistic_penguins_bill_length_mass}</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>_, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (label, model), ax <span class="kw">in</span> <span class="bu">zip</span>(models.items(), axes):</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    az.plot_separation(model, y<span class="op">=</span><span class="st">"yl"</span>, y_hat<span class="op">=</span><span class="st">"yl"</span>, ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"C4"</span>)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    ax.set_title(label)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-41-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>也可以通过 LOO 来比较模型的分类效果。</p>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>az.compare({<span class="st">"mass"</span>: trace_logistic_penguins_mass,</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>            <span class="st">"bill"</span>: trace_logistic_penguins_bill_length,</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mass_bill"</span>: trace_logistic_penguins_bill_length_mass}).<span class="bu">round</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/admin/blog/rock_blog/env/lib/python3.11/site-packages/arviz/stats/stats.py:803: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.7 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  warnings.warn(
/Users/admin/blog/rock_blog/env/lib/python3.11/site-packages/arviz/stats/stats.py:307: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise in a future error of pandas. Value 'True' has dtype incompatible with float64, please explicitly cast to a compatible dtype first.
  df_comp.loc[val] = (
/Users/admin/blog/rock_blog/env/lib/python3.11/site-packages/arviz/stats/stats.py:307: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise in a future error of pandas. Value 'log' has dtype incompatible with float64, please explicitly cast to a compatible dtype first.
  df_comp.loc[val] = (</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="60">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">elpd_loo</th>
<th data-quarto-table-cell-role="th">p_loo</th>
<th data-quarto-table-cell-role="th">elpd_diff</th>
<th data-quarto-table-cell-role="th">weight</th>
<th data-quarto-table-cell-role="th">se</th>
<th data-quarto-table-cell-role="th">dse</th>
<th data-quarto-table-cell-role="th">warning</th>
<th data-quarto-table-cell-role="th">scale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">mass_bill</td>
<td>0</td>
<td>-11.2</td>
<td>1.6</td>
<td>0.0</td>
<td>1.0</td>
<td>3.1</td>
<td>0.0</td>
<td>True</td>
<td>log</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bill</td>
<td>1</td>
<td>-28.0</td>
<td>1.0</td>
<td>16.7</td>
<td>0.0</td>
<td>5.0</td>
<td>3.9</td>
<td>False</td>
<td>log</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mass</td>
<td>2</td>
<td>-135.7</td>
<td>1.9</td>
<td>124.5</td>
<td>0.0</td>
<td>5.3</td>
<td>5.8</td>
<td>False</td>
<td>log</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="对数比率-log-odds-的解释" class="level3">
<h3 class="anchored" data-anchor-id="对数比率-log-odds-的解释">3.4.3. 对数比率 Log Odds 的解释</h3>
<p>在逻辑回归中，斜率告诉您当 x 增加一个单位时对数比率的增加。最简单的赔率是发生概率与不发生概率之间的比率。比如，我们从 Adelie 和 Chinstrap 企鹅中随机抽取一个企鹅，它是 Chinstrap 的概率是0.68。</p>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Class counts of each penguin species</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> penguins[<span class="st">"species"</span>].value_counts()</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>adelie_count <span class="op">=</span> counts[<span class="st">"Adelie"</span>],</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>chinstrap_count <span class="op">=</span> counts[<span class="st">"Chinstrap"</span>]</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>adelie_count <span class="op">/</span> (adelie_count <span class="op">+</span> chinstrap_count)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>array([0.68224299])</code></pre>
</div>
</div>
<p>同一事件的比率是：</p>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>adelie_count <span class="op">/</span> chinstrap_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>array([2.14705882])</code></pre>
</div>
</div>
<p>利用我们对比率的了解，我们可以定义 logit。 logit 是赔率的自然对数。则： <span class="math display">\[p = \frac{1}{1+e^{-\mathbf{X}\beta}}\]</span> <span class="math display">\[\log \left(\frac{p}{1-p} \right) = \boldsymbol{X} \beta\]</span></p>
<p>这种替代公式让我们将逻辑回归的系数解释为对数比率的变化。</p>
</section>
</section>
<section id="为回归模型选择先验" class="level2">
<h2 class="anchored" data-anchor-id="为回归模型选择先验">3.5. 为回归模型选择先验</h2>
<p>现在我们已经熟悉了广义线性模型，让我们关注先验及其对后验估计的影响。我们将借用一项研究，其探讨了父母的吸引力与这些父母生下女孩的百分比之间的关系。在这项研究中，研究人员按照五分制评估了美国青少年的吸引力。最终，这些受试者中的许多人有了孩子，计算了每个吸引力类别的性别比例。然而，这一次，要特别关注如何一起评估先验和可能性，而不是独立评估。</p>
<p>先选择一个非常宽的先验（近似无信息先验）：</p>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="op">-</span><span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.asarray([<span class="dv">50</span>, <span class="dv">44</span>, <span class="dv">50</span>, <span class="dv">47</span>, <span class="dv">56</span>])</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model_uninformative_prior_sex_ratio:</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    σ <span class="op">=</span> pm.Exponential(<span class="st">"σ"</span>, <span class="fl">.5</span>)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    β_1 <span class="op">=</span> pm.Normal(<span class="st">"β_1"</span>, <span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    β_0 <span class="op">=</span> pm.Normal(<span class="st">"β_0"</span>, <span class="dv">50</span>, <span class="dv">20</span>)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    μ <span class="op">=</span> pm.Deterministic(<span class="st">"μ"</span>, β_0 <span class="op">+</span> β_1 <span class="op">*</span> x)</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    ratio <span class="op">=</span> pm.Normal(<span class="st">"ratio"</span>, mu<span class="op">=</span>μ, sigma<span class="op">=</span>σ, observed<span class="op">=</span>y)</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    prior_predictive_uninformative_prior_sex_ratio <span class="op">=</span> pm.sample_prior_predictive(</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>        samples<span class="op">=</span><span class="dv">10000</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>    trace_uninformative_prior_sex_ratio <span class="op">=</span> pm.sample()</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>    trace_uninformative_prior_sex_ratio.extend(prior_predictive_uninformative_prior_sex_ratio)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [ratio, β_0, β_1, σ]
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [σ, β_1, β_0]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 24 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:04&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.ticker <span class="im">as</span> mtick</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>,<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">5.5</span>, <span class="dv">6</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">0</span>)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Take 50 samples from posterior</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>num_samples <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>chain_sample <span class="op">=</span> trace_uninformative_prior_sex_ratio.prior.chain.to_series().sample(num_samples, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>draw_sample <span class="op">=</span> trace_uninformative_prior_sex_ratio.prior.draw.to_series().sample(num_samples, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chain, draw <span class="kw">in</span> <span class="bu">zip</span>(chain_sample, draw_sample):</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    b_0_draw <span class="op">=</span> trace_uninformative_prior_sex_ratio.prior[{<span class="st">"draw"</span>:draw, <span class="st">"chain"</span>:chain}][<span class="st">"β_0"</span>].values</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    b_1_draw <span class="op">=</span> trace_uninformative_prior_sex_ratio.prior[{<span class="st">"draw"</span>:draw, <span class="st">"chain"</span>:chain}][<span class="st">"β_1"</span>].values</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot Line</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(x, b_0_draw<span class="op">+</span>b_1_draw<span class="op">*</span>x, c<span class="op">=</span><span class="st">"black"</span>, alpha<span class="op">=</span><span class="fl">.3</span>)</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Add median line later</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>b_0_hat <span class="op">=</span> trace_uninformative_prior_sex_ratio.prior[<span class="st">"β_0"</span>].values.mean()</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>b_1_hat <span class="op">=</span> trace_uninformative_prior_sex_ratio.prior[<span class="st">"β_1"</span>].values.mean()</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(x, b_0_hat<span class="op">+</span>b_1_hat<span class="op">*</span>x, c<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Add scatter plot</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].scatter(x, y)</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticks(x)</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].yaxis.set_major_formatter(mtick.PercentFormatter(decimals<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylim(<span class="dv">40</span>, <span class="dv">60</span>)</span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"</span><span class="sc">% o</span><span class="st">f Girl Babies"</span>)</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"Prior samples from uninformative priors"</span>)</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>b_0_hat, b_1_hat</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">0</span>)</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Take 10 sample from posterior</span></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>num_samples <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>chain_sample <span class="op">=</span> trace_uninformative_prior_sex_ratio.posterior.chain.to_series().sample(num_samples, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>draw_sample <span class="op">=</span> trace_uninformative_prior_sex_ratio.posterior.draw.to_series().sample(num_samples, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chain, draw <span class="kw">in</span> <span class="bu">zip</span>(chain_sample, draw_sample):</span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a>    b_0_draw <span class="op">=</span> trace_uninformative_prior_sex_ratio.posterior[{<span class="st">"draw"</span>:draw, <span class="st">"chain"</span>:chain}][<span class="st">"β_0"</span>].values</span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>    b_1_draw <span class="op">=</span> trace_uninformative_prior_sex_ratio.posterior[{<span class="st">"draw"</span>:draw, <span class="st">"chain"</span>:chain}][<span class="st">"β_1"</span>].values</span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot Line</span></span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot(x, b_0_draw<span class="op">+</span>b_1_draw<span class="op">*</span>x, c<span class="op">=</span><span class="st">"black"</span>, alpha<span class="op">=</span><span class="fl">.3</span>)</span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Add median line later</span></span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a>b_0_hat <span class="op">=</span> trace_uninformative_prior_sex_ratio.posterior[<span class="st">"β_0"</span>].values.mean()</span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>b_1_hat <span class="op">=</span> trace_uninformative_prior_sex_ratio.posterior[<span class="st">"β_1"</span>].values.mean()</span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(x, b_0_hat<span class="op">+</span>b_1_hat<span class="op">*</span>x, c<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Add scatter plot</span></span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].scatter(x, y)</span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticks(x)</span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].yaxis.set_major_formatter(mtick.PercentFormatter(decimals<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylim(<span class="dv">40</span>, <span class="dv">60</span>)</span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Attractiveness of Parent"</span>)</span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"</span><span class="sc">% o</span><span class="st">f Girl Babies"</span>)</span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"Posterior samples from uninformative priors"</span>)</span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a>b_0_hat, b_1_hat</span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].title.set_fontsize(<span class="dv">12</span>)</span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axes:</span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item <span class="kw">in</span> ([ax.title, ax.xaxis.label, ax.yaxis.label] <span class="op">+</span></span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a>                 ax.get_xticklabels() <span class="op">+</span> ax.get_yticklabels()):</span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a>        item.set_fontsize(<span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-46-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>经评估，<span class="math inline">\(\beta_1\)</span> 的影响约1.4。从数学角度来看，这个结果是有效的。但从我们的常识和我们对本研究之外的出生性别比的理解来看，这些结果是值得怀疑的。据测算，出生时的“自然”性别比约为 105 比 100 名女孩（男孩约为 103 至 107 人），这意味着出生时性别比为女性 48.5%，标准差为 0.5。此外，即使是与人类生物学更本质相关的因素也不会对出生率产生如此大的影响，从而削弱了主观吸引力应该产生如此大影响的观念。</p>
<p>让我们再次运行我们的模型，但这次先验与此常识一致。绘制我们的后验样本时，系数的集中度较小，并且在考虑可能的比率时，绘制的后验线落入更合理的范围内。</p>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model_informative_prior_sex_ratio:</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    σ <span class="op">=</span> pm.Exponential(<span class="st">"σ"</span>, <span class="fl">.5</span>)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note the now more informative priors</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    β_1 <span class="op">=</span> pm.Normal(<span class="st">"β_1"</span>, <span class="dv">0</span>, <span class="fl">.5</span>)</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    β_0 <span class="op">=</span> pm.Normal(<span class="st">"β_0"</span>, <span class="fl">48.5</span>, <span class="fl">.5</span>)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    μ <span class="op">=</span> pm.Deterministic(<span class="st">"μ"</span>, β_0 <span class="op">+</span> β_1 <span class="op">*</span> x)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    ratio <span class="op">=</span> pm.Normal(<span class="st">"ratio"</span>, mu<span class="op">=</span>μ, sigma<span class="op">=</span>σ, observed<span class="op">=</span>y)</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>    prior_predictive_informative_prior_sex_ratio <span class="op">=</span> pm.sample_prior_predictive(</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>        samples<span class="op">=</span><span class="dv">10000</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>    trace_informative_prior_sex_ratio <span class="op">=</span> pm.sample()</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>    trace_informative_prior_sex_ratio.extend(prior_predictive_informative_prior_sex_ratio)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [ratio, β_0, β_1, σ]
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [σ, β_1, β_0]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 21 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:02&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>,<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">5.5</span>, <span class="dv">6</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">0</span>)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Take 10 sample from posterior</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>num_samples <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>chain_sample <span class="op">=</span> trace_informative_prior_sex_ratio.prior.chain.to_series().sample(num_samples, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>draw_sample <span class="op">=</span> trace_informative_prior_sex_ratio.prior.draw.to_series().sample(num_samples, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chain, draw <span class="kw">in</span> <span class="bu">zip</span>(chain_sample, draw_sample):</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    b_0_draw <span class="op">=</span> trace_informative_prior_sex_ratio.prior[{<span class="st">"draw"</span>:draw, <span class="st">"chain"</span>:chain}][<span class="st">"β_0"</span>].values</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    b_1_draw <span class="op">=</span> trace_informative_prior_sex_ratio.prior[{<span class="st">"draw"</span>:draw, <span class="st">"chain"</span>:chain}][<span class="st">"β_1"</span>].values</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot Line</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(x, b_0_draw<span class="op">+</span>b_1_draw<span class="op">*</span>x, c<span class="op">=</span><span class="st">"black"</span>, alpha<span class="op">=</span><span class="fl">.3</span>)</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Add median line later</span></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>b_0_hat <span class="op">=</span> trace_informative_prior_sex_ratio.prior[<span class="st">"β_0"</span>].values.mean()</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>b_1_hat <span class="op">=</span> trace_informative_prior_sex_ratio.prior[<span class="st">"β_1"</span>].values.mean()</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(x, b_0_hat<span class="op">+</span>b_1_hat<span class="op">*</span>x, c<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Add scatter plot</span></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].scatter(x, y)</span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticks(x)</span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].yaxis.set_major_formatter(mtick.PercentFormatter(decimals<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylim(<span class="dv">40</span>, <span class="dv">60</span>)</span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"</span><span class="sc">% o</span><span class="st">f Girl Babies"</span>)</span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"Prior samples from informative priors"</span>)<span class="op">;</span></span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">0</span>)</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>num_samples <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>chain_sample <span class="op">=</span> trace_informative_prior_sex_ratio.posterior.chain.to_series().sample(num_samples, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a>draw_sample <span class="op">=</span> trace_informative_prior_sex_ratio.posterior.draw.to_series().sample(num_samples, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chain, draw <span class="kw">in</span> <span class="bu">zip</span>(chain_sample, draw_sample):</span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>    b_0_draw <span class="op">=</span> trace_informative_prior_sex_ratio.posterior[{<span class="st">"draw"</span>:draw, <span class="st">"chain"</span>:chain}][<span class="st">"β_0"</span>].values</span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a>    b_1_draw <span class="op">=</span> trace_informative_prior_sex_ratio.posterior[{<span class="st">"draw"</span>:draw, <span class="st">"chain"</span>:chain}][<span class="st">"β_1"</span>].values</span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot Line</span></span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot(x, b_0_draw<span class="op">+</span>b_1_draw<span class="op">*</span>x, c<span class="op">=</span><span class="st">"black"</span>, alpha<span class="op">=</span><span class="fl">.3</span>)</span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Add median line later</span></span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a>b_0_hat <span class="op">=</span> trace_informative_prior_sex_ratio.posterior[<span class="st">"β_0"</span>].values.mean()</span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a>b_1_hat <span class="op">=</span> trace_informative_prior_sex_ratio.posterior[<span class="st">"β_1"</span>].values.mean()</span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(x, b_0_hat<span class="op">+</span>b_1_hat<span class="op">*</span>x, c<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Add scatter plot</span></span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].scatter(x, y)</span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticks(x)</span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].yaxis.set_major_formatter(mtick.PercentFormatter(decimals<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylim(<span class="dv">40</span>, <span class="dv">60</span>)</span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Attractiveness of Parent"</span>)</span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"</span><span class="sc">% o</span><span class="st">f Girl Babies"</span>)</span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"Posterior samples from informative priors"</span>)</span>
<span id="cb73-59"><a href="#cb73-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-60"><a href="#cb73-60" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axes:</span>
<span id="cb73-61"><a href="#cb73-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item <span class="kw">in</span> ([ax.title, ax.xaxis.label, ax.yaxis.label] <span class="op">+</span></span>
<span id="cb73-62"><a href="#cb73-62" aria-hidden="true" tabindex="-1"></a>                 ax.get_xticklabels() <span class="op">+</span> ax.get_yticklabels()):</span>
<span id="cb73-63"><a href="#cb73-63" aria-hidden="true" tabindex="-1"></a>        item.set_fontsize(<span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-48-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>这次我们看到吸引力对性别的估计影响可以忽略不计，根本没有足够的信息来影响后验。正如我们在第一章量化先验信息的几个选项中提到的，选择先验既是一种负担，也是一种祝福。无论您相信哪一种，重要的是要以可解释且有原则的选择来使用此统计工具。</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>